\subsection{Конфігурація нейромережі}

Нейромережа, яка керує автомобілем, повинна мати три входи та два виходи. На входи подаються дані про віддалі об'єктів в межах однієї з трьох підобластей поля зору автомобіля (лівої, центральної та правої), а на виході отримуються дані про необхідну зміну прискорення автомобіля та кута повороту коліс. Обидва параметри знаходяться в діапазоні $[-1,1]$. В випадку прискорення від'ємне значення відповідає гальмуванню або руху автомобіля назад, в залежності від того, в яку сторону рухається автомобіль в даний момент. Для кута повороту значення -1 відповідає максимальному повороту наліво, 0 "--- руху прямо, -1 "--- максимальному повороту направо.

В результаті експериментів з різноманітними конфігураціями нейромережі, було обрано конфігурацію з п'ятьма прошарками. На вході "--- 3 сенсорних нейрони, в трьох прихованих прошарках міститься 10, 13 та 16 прихованих нейрона, в вихідному прошарку "--- два вихідних, які відповідають прискоренню та куту повороту. Схематично архітектуру мережі подано на рис.~\ref{nnet_conf}.
\begin{figure}
\centering
\includegraphics[width=1.0\textwidth]{nnet_conf.eps}
\caption{Конфігурація нейромережі, використаної в проекті (3-10-13-16-2)} \label{nnet_conf}
\end{figure}

\subsection{Поле зору}

\begin{figure}
\centering
\includegraphics[width=0.5\textwidth]{visible_range.eps}
\caption{Поле зору автомобіля} \label{visible_range}
\end{figure}
Поле зору автомобіля має вигляд сектора з початковою точкою $O$, радіусом $MaxDistance$, рівним максимальній дальності видимості автомобіля, та кутом $\alpha$, рівним куту огляду автомобіля. Вся область видимості розбивається на три рівні частини з кутом $\frac{\alpha}{3}$. Кожній області "--- лівій, центральній та правій "--- відповідає свій вхід нейромережі (рис.~\ref{nnet_conf}).

Значення, яке подається на відповідний вхід нейромережі обчислюється наступним чином. Знаходиться об'єкт, який хоча б частково попадає у заданий сектор, обчислюється відстань від точки $O$ до найближчої точки об'єкта, яка знаходиться в заданому секторі. Значенням, яке подається на відповідний вхід нейромережі, буде відношенням знайденої відстані до значення максимальної дальності видимості $MaxDistance$, або $1.0$, якщо немає жодного об'єкту, який би попадав в даний сектор:
\begin{equation}
Input = \left\{ 
\begin{array}{ll}
\frac{|O - ClosestPoint|}{MaxDistance}, & \textrm{якщо є об'єкт, який попадає у сектор;}\\
1.0, & \textrm{якщо жоден об'єкт не перетинає сектор.}\\
\end{array}
\right.
\end{equation}

\subsection{Алгоритм визначення попадання об'єкта в сектор}

Для визначення того, чи попадає об'єкт, поданий своїм обмежуючим багатокутником, в заданий сегмент, потрібно здійснити наступні дії:
\begin{enumerate}
\item Перевіряємо кожну кутову точку на попадання у заданий сектор (як це здійснити буде пояснено нижче). Якщо точка попадає в сектор, визначаємо відстань від неї, до початку сектора. Якщо ця відстань менша, ніж поточне значення мінімальної відстані $MinDistance$ (яке на початку ініціалізується значенням $MaxDistance$), то присвоюємо нове значення мінімальної відстані.
\item Перевіряємо кожен відрізок обмежуючого багатокутника. Якщо хоча б одна з крайніх точок відрізка попадає в сектор або відрізок перетинає хоча б одну з бокових сторін сектора, то відрізок попадає в сектор. Тоді знаходимо мінімум відстаней серед всіх цих точок і при потребі змінюємо поточний мінімум відстані.
\item Повертаємо відношення $\frac{MinDistance}{MaxDistance}$ як результат. \end{enumerate}

Розглянемо тепер алгоритм визначення попадання точки в сектор. Але перед тим визначимо \emph{скалярний та векторний добутки векторів}, а також покажемо як здійснити поворот вектора на певний кут.

\textbf{Озн.} \emph{Скалярним добутком} двох двовимірних векторів $\vec v_1(x_1; y_1)$ та $\vec v_2(x_2;y_2)$ називається дійсне число, яке обчислюється за наступним правилом:
\begin{equation}
(\vec v_1, \vec v_2) = \vec v_1 \cdotp \vec v_2 = x_1x_2 + y_1y_2.
\end{equation}

\textbf{Озн.} \emph{Векторним добутком} двох двовимірних векторів $\vec v_1(x_1; y_1)$ та $\vec v_2(x_2;y_2)$ називається дійсне число, яке обчислюється за наступним правилом:
\begin{equation}
[\vec v_1, \vec v_2] = \vec v_1 \times \vec v_2 = \left|
\begin{array}{cc}
x_1 & y_1\\
x_2 & y_2\\
\end{array}\right| = x_1y_2-y_1x_2.
\end{equation}
%  vec.X * (float)Math.Cos(alpha) - vec.Y * (float)Math.Sin(alpha), 
%  vec.X * (float)Math.Sin(alpha) + vec.Y * (float)Math.Cos(alpha)

Вектор $\vec v(x, y)$, повернений на $\varphi$ радіан проти годинникової стрілки, можна визначити наступним чином:
\begin{equation}
\vec v_\varphi = (x cos(\varphi) - y sin(\varphi), \quad x sin(\varphi) + y cos(\varphi)).
\end{equation}

\emph{Визначення попадання точки в сектор}. Якщо сектор заданий одиничним напрямним вектором $\vec v$, початковою точкою $O$, центральним кутом $\alpha$ та радіусом $R$, і потрібно визначити чи попадає точка $P$ в цей сектор, то виконуємо наступні дії:
\begin{enumerate}
\item Знаходимо напрямні вектори правої та лівої сторін сегменту, $\vec v_L$ та $\vec v_R$, повернувши напрямний вектор на $\frac{\alpha}{2}$ та $-\frac{\alpha}{2}$ радіан відповідно.
\item Точка $P$ належить даному сектору тоді і тільки тоді, коли вона лежить між прямими, що задаються напрямними векторами $\vec v_L$ та $\vec v_R$, вектор $\overrightarrow{OP}$ утворює з вектором $\vec v$ гострий кут та відстань від точки $P$ до $O \leq R$. Цьому критерію відповідає наступна умова:
\begin{equation}
((\vec v_L \times \overrightarrow{OP}) (\vec v_R \times \overrightarrow{OP}) < 0) \land (\vec v \cdotp \overrightarrow{OP} > 0) \land (|P-O| < R).
\end{equation}
\end{enumerate}

\subsection{Навчальна вибірка}

Навчання мережі "--- один з основних моментів в реалізації проекту. Правильно вибрана множина навчальних прикладів може дати чудові результати на практиці. В той же час, невеликі зміни у навчальних прикладах можуть призвести до суттєвих змін в поведінці нейромережі і, відповідно, керованого автомобіля. Після численних експериментів, ми зупинилися на наступній навчальній вибірці (див. табл.~\ref{samples}).

Кожен рядок табл.~\ref{samples} відповідає одному навчальному прикладу. Перші три стовпці відповідають трьом входам нейромережі, а саме "--- відстаням до об'єктів в межах лівої, центральної та правої підобластей відповідно. Наступні два "--- прискорення та поворот, в заданому порядку. 
\begin{table}
\caption{Навчальна вибірка} \label{samples}
\centering
\begin{tabular}{|c|c|c|c|c|}
\hline
\multicolumn{3}{|c|}{Вхідні нейрони} & \multicolumn{2}{|c|}{Вихідні нейрони} \\
\hline
\phantom{20}Зліва\phantom{20} & \phantom{8}По центру\phantom{8} & \phantom{20}Справа\phantom{20} & \phantom{5}Прискорення\phantom{5} & \phantom{13}Поворот\phantom{13}\\ \hline \hline
1,0	&	1,0	&	1,0	&	1,0	&	0,0	\\ \hline
0,5	&	1,0	&	1,0	&	0,8	&	0,4	\\ \hline
1,0	&	1,0	&	0,5	&	0,8	&	-0,4	\\ \hline
1,0	&	0,5	&	1,0	&	0,4	&	-0,4	\\ \hline
0,5	&	1,0	&	0,5	&	0,5	&	0,0	\\ \hline
0,0	&	0,0	&	0,0	&	-1,0	&	-1,0	\\ \hline
0,5	&	0,5	&	0,5	&	-0,5	&	-1,0	\\ \hline
0,0	&	1,0	&	1,0	&	0,4	&	0,6	\\ \hline
1,0	&	1,0	&	0,0	&	0,4	&	-0,6	\\ \hline
1,0	&	0,0	&	1,0	&	-0,8	&	-0,8	\\ \hline
0,0	&	1,0	&	0,0	&	1,0	&	0,0	\\ \hline
0,0	&	0,0	&	1,0	&	0,7	&	1,0	\\ \hline
1,0	&	0,0	&	0,0	&	0,7	&	-1,0	\\ \hline
0,3	&	0,4	&	0,1	&	0,4	&	-0,5	\\ \hline
0,1	&	0,4	&	0,3	&	0,4	&	0,5	\\ \hline
0,0	&	0,1	&	0,2	&	0,3	&	0,8	\\ \hline
0,2	&	0,1	&	0,0	&	0,3	&	-0,8	\\ \hline
0,0	&	0,3	&	0,6	&	0,6	&	0,8	\\ \hline
0,6	&	0,3	&	0,0	&	0,6	&	-0,8	\\ \hline
0,2	&	0,3	&	0,4	&	0,4	&	0,7	\\ \hline
0,4	&	0,3	&	0,2	&	0,4	&	-0,7	\\ \hline
\end{tabular}
\end{table}

При створенні навчальної множини за основу була взята навчальна множина з \cite{Kun03}, адаптована до особливостей нашої реалізації автомобіля, оскільки фізика автомобіля в \cite{Kun03} суттєво відрізняється від реалізованої в нашому проекті. До кожної ситуації підбиралися параметри прискорення та повороту, які, на нашу думку, найкраще відповідають кожній конкретній ситуації. Наприклад, ситуації, коли перед автомобілем немає жодних перешкод, відповідає вхід $(1.0, 1.0, 1.0)$. Найбільш природнім у цій ситуації буде рух вперед з максимальним прискоренням без зміни напрямку. Відповідно, бажаним виходом був прийнятий вектор $(1.0, 0.0)$, що якраз відповідає максимальному прискоренню та нульовому повороту керма. Ще одним прикладом може слугувати різкий поворот направо, якому відповідає вхід $(0.2, 0.3, 0.4)$. Цілком адекватним у цій ситуації буде невелике значення прискорення та не доволі сильний поворот керма направо. Тому цьому входу поставлено у відповідність вихід $(0.4, 0.7)$.

Шляхом низки експериментів, під час яких змінювалися бажані виходи, після чого автомобіль тестувався на адекватність поведінки на кількох типових трасах, було підібрано найбільш вдалий набір вихідних параметрів.

Навчена на цій навчальній множині, нейромережа адекватно реагує на перешкоди у абсолютній більшості випадків і забезпечує природну поведінку автомобіля. Щоправда, у випадку попадання у кут автомобілю не завжди вдається вийти з цієї ситуації і після кількох спроб розвернутися автомобіль зупиняється на місці (застрягає) (див.~\ref{stuck}). Це пов'язано з тим, що в такій ситуації потрібно робити розворот назад, проте домогтися цього підбором параметрів навчальної множини не вдалося. Можливих виходів з ситуації ми бачимо два: 
\begin{figure} \begin{center}
\includegraphics[width=0.7\textwidth]{stuck.eps}
\caption{Автомобіль застряг в куті} \label{stuck}
\end{center} \end{figure}
\begin{enumerate}
\item Введення у представлення стану динамічної системи (автомобіля) більшої кількості параметрів, наприклад, поточної швидкості. В цьому випадку, можливо, можна було б домогтися хорошої реакції автомобіля в ситуації, в яких вона на даний час застрягає. Проте збільшення параметрів стану потребує значного збільшення кількості навчальних прикладів, а також їх дуже точний підбір. Була спроба ввести в стан системи параметр поточної швидкості, проте бажаних результатів вона не дала. Тим не менше, це не означає, що неможливо досягти вказаної мети шляхом більш точного підбору навчальних прикладів.
\item ``Ручний контроль'' над автомобілем. Можна відслідковувати рух автомобіля і, якщо протягом певного часу автомобіль не зрушив з місця,"--- ``перебирати'' контроль від нейромережі на певну внутрішню логіку програми, робити розворот і вже тоді вертати контроль над автомобілем назад нейромережі. Цей підхід пов'язаний зі значним ускладненням логіки роботи програми, оскільки потрібно виконувати контроль за об'єктами, що знаходяться позаду автомобіля. Та й загалом це був би відхід від ідеї контролю за динамічною системою з використанням нейромережі.
\end{enumerate}

Таким чином, на даний момент не було знайдено задовільного рішення вказаної проблеми. В майбутньому можна спробувати вдосконалити управління автомобілем шляхом використання іншої архітектури нейромережі, яка б давала змогу проводити самонавчання без участі ``вчителя''.
